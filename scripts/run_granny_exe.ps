<#
    Script to download a file from http://andrewbaker.ddns.net
    Shows progress bar with percent and ETA
#>

# URL of the file
$url = "http://andrewbaker.ddns.net/download/granny.zip"

# Path to the user's Downloads folder
$downloads = [Environment]::GetFolderPath("UserProfile") + "\Downloads"
$output = Join-Path $downloads "granny.zip"

Write-Host "Starting download from $url ..."
$startTime = Get-Date

# Create web client
$response = Invoke-WebRequest -Uri $url -Method Head
$totalBytes = [int64]$response.Headers["Content-Length"]

# Open streams
$req = [System.Net.HttpWebRequest]::Create($url)
$res = $req.GetResponse()
$stream = $res.GetResponseStream()
$file = [System.IO.FileStream]::new($output, [System.IO.FileMode]::Create)

# Buffer settings
$buffer = New-Object byte[] (8192)
$bytesRead = 0
$downloadedBytes = 0

while (($bytesRead = $stream.Read($buffer, 0, $buffer.Length)) -gt 0) {
    $file.Write($buffer, 0, $bytesRead)
    $downloadedBytes += $bytesRead

    # Progress %
    $percent = [math]::Round(($downloadedBytes / $totalBytes) * 100, 2)

    # Speed + ETA
    $elapsed = (Get-Date) - $startTime
    $speed = if ($elapsed.TotalSeconds -gt 0) { $downloadedBytes / $elapsed.TotalSeconds } else { 0 }
    $remaining = if ($speed -gt 0) { ($totalBytes - $downloadedBytes) / $speed } else { 0 }

    Write-Progress -Activity "Downloading file" `
                   -Status "$percent% complete | ETA: $([math]::Round($remaining))s" `
                   -PercentComplete $percent
}

# Cleanup
$file.Close()
$stream.Close()
$res.Close()

Write-Host "Download complete: $output"
